{
  "Name": "kaerecomputer-blog-web-acl",
  "Scope": "CLOUDFRONT",
  "DefaultAction": {
    "Allow": {}
  },
  "Description": "Baseline WAF for blog post paths (/posts/*) with crawler and scraper protection.",
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "kaerecomputerBlogWebAcl"
  },
  "Rules": [
    {
      "Name": "AllowKnownSearchBots",
      "Priority": 1,
      "Statement": {
        "RegexPatternSetReferenceStatement": {
          "ARN": "REPLACE_WITH_YOUR_UA_ALLOWLIST_REGEX_PATTERN_SET_ARN",
          "FieldToMatch": {
            "SingleHeader": {
              "Name": "user-agent"
            }
          },
          "TextTransformations": [
            {
              "Priority": 0,
              "Type": "LOWERCASE"
            }
          ]
        }
      },
      "Action": {
        "Allow": {}
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "allowKnownSearchBots"
      }
    },
    {
      "Name": "ManagedCommonRuleSet",
      "Priority": 10,
      "Statement": {
        "ManagedRuleGroupStatement": {
          "VendorName": "AWS",
          "Name": "AWSManagedRulesCommonRuleSet"
        }
      },
      "OverrideAction": {
        "None": {}
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "managedCommonRuleSet"
      }
    },
    {
      "Name": "ManagedKnownBadInputsRuleSet",
      "Priority": 11,
      "Statement": {
        "ManagedRuleGroupStatement": {
          "VendorName": "AWS",
          "Name": "AWSManagedRulesKnownBadInputsRuleSet"
        }
      },
      "OverrideAction": {
        "None": {}
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "managedKnownBadInputsRuleSet"
      }
    },
    {
      "Name": "ManagedBotControlForPostsOnly",
      "Priority": 20,
      "Statement": {
        "ManagedRuleGroupStatement": {
          "VendorName": "AWS",
          "Name": "AWSManagedRulesBotControlRuleSet",
          "ManagedRuleGroupConfigs": [
            {
              "AWSManagedRulesBotControlRuleSet": {
                "InspectionLevel": "TARGETED"
              }
            }
          ],
          "ScopeDownStatement": {
            "ByteMatchStatement": {
              "SearchString": "/posts/",
              "FieldToMatch": {
                "UriPath": {}
              },
              "TextTransformations": [
                {
                  "Priority": 0,
                  "Type": "NONE"
                }
              ],
              "PositionalConstraint": "STARTS_WITH"
            }
          }
        }
      },
      "OverrideAction": {
        "None": {}
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "managedBotControlForPostsOnly"
      }
    },
    {
      "Name": "RateLimitPostsPerIp",
      "Priority": 30,
      "Statement": {
        "RateBasedStatement": {
          "Limit": 300,
          "AggregateKeyType": "IP",
          "ScopeDownStatement": {
            "ByteMatchStatement": {
              "SearchString": "/posts/",
              "FieldToMatch": {
                "UriPath": {}
              },
              "TextTransformations": [
                {
                  "Priority": 0,
                  "Type": "NONE"
                }
              ],
              "PositionalConstraint": "STARTS_WITH"
            }
          }
        }
      },
      "Action": {
        "Block": {}
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "rateLimitPostsPerIp"
      }
    },
    {
      "Name": "RateLimitAggressivePostsBurst",
      "Priority": 31,
      "Statement": {
        "RateBasedStatement": {
          "Limit": 120,
          "AggregateKeyType": "IP",
          "ScopeDownStatement": {
            "AndStatement": {
              "Statements": [
                {
                  "ByteMatchStatement": {
                    "SearchString": "/posts/",
                    "FieldToMatch": {
                      "UriPath": {}
                    },
                    "TextTransformations": [
                      {
                        "Priority": 0,
                        "Type": "NONE"
                      }
                    ],
                    "PositionalConstraint": "STARTS_WITH"
                  }
                },
                {
                  "NotStatement": {
                    "Statement": {
                      "RegexPatternSetReferenceStatement": {
                        "ARN": "REPLACE_WITH_YOUR_UA_ALLOWLIST_REGEX_PATTERN_SET_ARN",
                        "FieldToMatch": {
                          "SingleHeader": {
                            "Name": "user-agent"
                          }
                        },
                        "TextTransformations": [
                          {
                            "Priority": 0,
                            "Type": "LOWERCASE"
                          }
                        ]
                      }
                    }
                  }
                }
              ]
            }
          }
        }
      },
      "Action": {
        "Challenge": {}
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "rateLimitAggressivePostsBurst"
      }
    },
    {
      "Name": "BlockEmptyUserAgentOnPosts",
      "Priority": 40,
      "Statement": {
        "AndStatement": {
          "Statements": [
            {
              "ByteMatchStatement": {
                "SearchString": "/posts/",
                "FieldToMatch": {
                  "UriPath": {}
                },
                "TextTransformations": [
                  {
                    "Priority": 0,
                    "Type": "NONE"
                  }
                ],
                "PositionalConstraint": "STARTS_WITH"
              }
            },
            {
              "SizeConstraintStatement": {
                "FieldToMatch": {
                  "SingleHeader": {
                    "Name": "user-agent"
                  }
                },
                "ComparisonOperator": "EQ",
                "Size": 0,
                "TextTransformations": [
                  {
                    "Priority": 0,
                    "Type": "NONE"
                  }
                ]
              }
            }
          ]
        }
      },
      "Action": {
        "Block": {}
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "blockEmptyUserAgentOnPosts"
      }
    },
    {
      "Name": "BlockKnownScraperUserAgentsOnPosts",
      "Priority": 41,
      "Statement": {
        "AndStatement": {
          "Statements": [
            {
              "ByteMatchStatement": {
                "SearchString": "/posts/",
                "FieldToMatch": {
                  "UriPath": {}
                },
                "TextTransformations": [
                  {
                    "Priority": 0,
                    "Type": "NONE"
                  }
                ],
                "PositionalConstraint": "STARTS_WITH"
              }
            },
            {
              "RegexPatternSetReferenceStatement": {
                "ARN": "REPLACE_WITH_YOUR_BAD_UA_REGEX_PATTERN_SET_ARN",
                "FieldToMatch": {
                  "SingleHeader": {
                    "Name": "user-agent"
                  }
                },
                "TextTransformations": [
                  {
                    "Priority": 0,
                    "Type": "LOWERCASE"
                  }
                ]
              }
            }
          ]
        }
      },
      "Action": {
        "Block": {}
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "blockKnownScraperUserAgentsOnPosts"
      }
    }
  ]
}
